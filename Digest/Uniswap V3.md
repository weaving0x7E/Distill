译自： https://uniswapv3book.com/index.html
# Milestone 0. Background
## 1.Introduction to Markets
### How Centralized Exchanges Work
在本书中我们将构建一个运行于Ethereum的去中心化交易所（DEX）。所有中心化交易所的核心都有一个订单簿。订单簿只是一个日志，它存储了交易者想要发出的所有卖单和买单。在这本书中，每个订单都包含了订单必须执行的价格和必须购买或出售的金额。

![[Pasted image 20250214142545.png]]

要进行交易，就必须有流动性，即流动性是市场上的资产供应。如果你想买一个衣柜，但没有人卖，那就没有流动性。如果你想卖一个衣柜，但没有人愿意买，那么就是存在流动性但没有买家。如果没有流动性，就没有东西可买或可卖。
在中心化交易所，订单簿是积累流动性的地方。如果有人下卖单，他们就为市场提供了流动性。如果有人下买单，他们就希望市场有流动性，否则就不可能有交易。
当没有流动性，但市场仍对交易感兴趣时，做市商就会发挥作用。做市商是为市场提供流动性的公司或个人，也就是拥有大量资金并购买不同资产在交易所出售的人。做市商的报酬由交易所支付。做市商通过向交易所提供流动性来赚钱。
### How Decentralized Exchanges Work
去中心化交易所也需要流动性。它们还需要有人为各种资产的交易者提供服务。然而，这个过程不能以中心化的方式处理。有多种去中心化的解决方案，实现方式各不相同。我们的重点是Uniswap如何解决这个问题。
### Automated Market Makers
[The evolution of on-chain markets](https://bennyattar.substack.com/p/the-evolution-of-amms)解释了什么是自动做市商（AMM）。顾名思义，这种算法的工作方式与做市商完全相同，但却是自动化的。此外，它是去中心化和无权限的，也就是说：
* 不受单一实体管理；
* 所有资产都不存储在单一位置；
* 任何人都可以在任何地方使用它。
#### What Is an AMM?
AMM是一组智能合约，定义了如何管理流动性。每个交易对（例如ETH/USDC）都是一个单独的合约，存储ETH和USDC，并为交易基础能力：将ETH交换为USDC，反之亦然。
AMM的核心思想是池化（**pooling**）：每个合约都是一个存储流动性的池，并允许不同用户（包括其他智能合约）以无需许可的方式进行交易。有两个角色，流动性提供者和交易者，这些角色通过流动性池相互作用，它们与池交互的方式是预先设定的，不可变的。

![[Pasted image 20250214143758.png]]

这种方法与中心化交易所的不同之处在于，智能合约是完全自动化的，不需要任何人管理。没有经理、管理员、特权用户等。只有LP和交易者（他们可以是同一个人），所有的算法都是预定义的，不可变的，公开的。
现在让我们看看Uniswap如何实现AMM。

## 2.Constant Function Market Makers
	本章重述了Uniswap V2的白皮书。理解这些数学知识对于构建类似Uniswap的DEX至关重要，但如果你在现阶段不完全理解也没关系。
正如我在上一节中提到的，构建 AMM 有不同的方法。我们将重点关注并构建一种特定类型的 AMM——恒定乘积市商（Constant Function Market Maker）。不要被这个长长的名字吓到！它的核心是一个非常简单的数学公式：

$$
x∗y=k
$$

就这样，这就是AMM。
$x$和$y$是池合约储备——它目前持有的token数量。$k$只是它们的乘积，具体的值并不重要。
这个恒等式表明：每次交易后，$k$必须保持不变。当交易者进行交易时，他们将一定量的一种token放入池中（他们想要出售的token），并从池中取出一定量的另一种token（他们想要购买的token）。这改变了池的储备，恒定乘积公式规定储备的乘积一定不会改变。正如我们将在本书中多次看到的那样，这个简单的要求是Uniswap工作的核心算法。
### The Trade Function

$$
(x+rΔx)(y−Δy)=k
$$

1. 池中有一定数量的token0($x$)和token1($y$)
2. 当我们用token0购买token1时，我们会将一定数量的token0交给池($Δx$)
3. 池给我们一定数量的token1作为交换($Δy$)
4. 池还会从我们提供的token0中收取少量费用($r$=1-swap fee)
5. token0储备量会发生变化($x+rΔx$)，token1的储备量也会发生变化($y-Δy$)
6. 更新后的储备量乘积仍必须等于$k$
简单讲就是给一个池一定量的token0并获得一定量的token1。池的职能是以公平的价格计算出正确数量的token1。现在我们讨论一下如何计算价格。
### Pricing
由于池是独立的智能合约，因此池中的token是以彼此为单位定价的。例如：在ETH/USDC池中，ETH以USDC计价，USDC以ETH计价。如果1 ETH的价格是1000 USDC，那么1 USDC 的价格就是0.001 ETH。任何其他币池也是如此，无论它是否是稳定币对（如 ETH/BTC）。
在现实世界中，供需关系决定价格。AMM也是如此。我们暂且将需放在一边，重点关注供。
池中token的价格由token的供应量决定，即由池持有的token储备量决定。

$$
Px​=\frac{y}{x}​,Py​=\frac{x}{y}​
$$

$Px$和$Py$是token的价格，以其他token作为单位。
这种价格被称为现货价格，它们只反映当前的市场价格。然而，实际交易价格的计算方式不同。这就是我们要把需纳入考虑。根据供需关系，高需求会提高价格，这是我们在非受控系统中需要实现的属性。当需求高时，价格升高，我们可以使用池储备来衡量需求：用户想从池中得到的token越多（相对于池的储备），需求的影响就越大。
让我们回到交易公式：

$$
(x+rΔx)(y−Δy)=xy
$$

由上式可得：

$$
Δy=\frac{yrΔx}{x+rΔx}
$$

​$$
Δx=\frac{xΔy}{r(y−Δy)}​
$$

利用这些式子可以避免计算“价格”，也可以直接算得售/买token的数量
### The Curve
上面这些数学太枯燥啦，来图像化它吧

![[Pasted image 20250214150853.png]]

恒定乘积公式的图像是一个二次双曲线，横/纵轴代表池的储备。每次交易始于曲线上的一个点它对应着此时的储备比值。为了计算输出多少token，我们需要在曲线上找到一个$x$坐标为$x+Δx$的点，它对应的`y`坐标就是swap出的目标token数量。
比如说：

![[Pasted image 20250214151536.png]]

1. 紫色的是价格曲线，坐标轴是池的储备（注意它们在起始价格时相等）
2. 起始价格是1
3. 我们卖了200个token0。如果我们只使用起始价格，我们期望获得200个token1
4. 然而，交易价格是0.666，所以我们只得到133.333个token1
这个例子用Uniswap的发起人之一[Dan Robinson](https://twitter.com/danrobinson)创建的[the Desmos chart](https://www.desmos.com/calculator/7wbvkts2jf)制作，为了更好地直观地了解它是如何工作的，可以尝试修改图表，尝试不同的储量，看看当$Δx$相对于$x$较小时，输出量是如何变化的。
我猜你一定在想，为什么要使用这样的曲线。这似乎是在惩罚大额交易者。这是事实，也是一种理想的特性！供需关系告诉我们，当需求高时（供应不变），价格也会高。需求低时，价格也低。市场就是这样运作的。神奇的是，恒定乘积公式实现了这一机制！需求由购买的数量决定，而供给则是储备。当你想买的数量相对于储备量大时，价格就会比你想买的数量少时高。如此简单的公式保证了如此强大的机制！
尽管Uniswap不计算交易价格，但我们仍然可以在曲线上看到交易价格。但要注意，在进行交易时会出现多个价格：
1. 在交易之前，存在一个现货价格。它等于储备比例$\frac{y}{x}$或$\frac{x}{y}$这取决于交易方向。该价格也是起点切线的斜率
2. 完成交易后在曲线上出现新的现货价格
3. 交易的实际价格是连接两点的直线斜率

## 3.Introduction to Uniswap V3
	本章重述了Uniswap V3白皮书。同样，如果你不理解所有概念也没关系。开始编码后它们会逐渐清晰。
为了更好地理解Uniswap V3带来的创新，我们先来看看Uniswap V2的不完善之处。
Uniswap V2是一个通用交易所，采用一种AMM算法。然而，并非所有交易对都是平等的。交易对可以按价格波动性分组：
1. 大多数token波动性较大，因为它们的价格并不与某种东西挂钩，会受到市场波动的影响
2. 低波动token，这一组包括锚定token，主要是稳定币：USDC/USDT、USDC/DAI、USDT/DAI 等。此外还有 ETH/stETH、ETH/rETH（封装 ETH 的变种）。
这些组别需要不同的池配置。主要区别在于，锚定token需要较高的流动性，以减少大额交易带来的剧烈波动。无论我们要买卖的token数量有多大，USDC和USDT的价格都必须保持接近1。由于 Uniswap V2的通用AMM算法不太适合稳定币交易，alternative AMM（主要是 Curve）在稳定币交易中更受欢迎。
造成这个问题的原因是，Uniswap V2池中的流动性是无限分布的——池中的流动性允许从0到无穷大的任何价格进行交易：

![[Pasted image 20250214153909.png]]

这看似不是坏事，但却使资本利用率低下。资产的历史价格会保持在某个确定的范围内，无论是窄范围还是宽范围。例如，ETH的历史价格范围为0.75至4,800美元（根据 CoinMarketCap 的数据）。今天（2022年6月，1个ETH的价格为1800美元），没有人会以 5000 美元的价格购买 1 个ETH，因此以这个价格提供流动性毫无意义。因此，在远离当前价格或永远不会达到的价格区间提供流动性是没有意义的。
### Concentrated Liquidity
Uniswap V3引入了集中流动性：LP现在可以选择他们想要提供流动性的价格范围。通过允许将更多的流动性投入一个狭窄的价格区间，以提高了资本效率，这使得Uniswap更加多样化：它现在可以为不同波动性的货币对配置资金池。这就是V3对V2的改进。
简而言之，一个Uniswap V3 pair是许多小的Uniswap V2 pair。V2和V3的主要区别是，在V3中，一个pair有许多价格范围。每一个较小的价格区间都有有限的储备。从0到无穷大的整个价格区间被分割成更短的价格区间，每个区间都有自己的流动性。更关键的是，在较小的价格范围内，它的工作原理与Uniswap V2完全相同。这就是为什么我说一个V3 pair是许多小的V2 pair。
现在，我们试着把它具象化。我们不希望曲线是无限大的。把曲线在点a和点b处切分，横纵轴作为边界得到下图：

![[Pasted image 20250214154124.png]]

正如我们在前一章所看到的，购买或出售token会使价格沿着曲线移动。价格区间限制了价格的变动。当价格移动到任何一个点时，池将耗尽：其中一个token储备将为0。
在上面的图表中，我们假设起始价格在曲线的中间。为了到达点a，我们需要购买范围内所有可用的y以最大化x；为了到达b点，我们需要购买范围内所有可用的x以最大化y。
在交易时当前价格区间被耗尽时会发生什么？价格会滑落到下一个价格区间。如果下一个价格区间不存在，交易最终会部分完成——我们将在本书后面看到这是如何运作的。

![[Pasted image 20250214154857.png]]

这是流动性在USDC/ETH池中的分布情况。你可以看到，在当前价格附近流动性充足，离当前价格越远，流动性越少——这是因为LP努力提高其资本的效率。
### The Mathematics of Uniswap V3
在数学上，Uniswap V3基于V2：它使用相同的公式，但......我们也许可以把它称为增强公式。
为了处理价格区间的转换、简化流动性管理并避免四舍五入错误，Uniswap V3使用了这些新概念：

$$
L=\sqrt{xy}​
$$

$$
\sqrt{P}​=\sqrt{\frac{y}{x}}​​
$$

$L$是流动性数量。池中的流动性是token的组合。我们知道这两个数字的乘积为$k$，因此可以得出流动性的衡量标准，即$\sqrt{xy}$（$x$和$y$的几何平均数）
$y/x$是以token1为单位token0的价格。因此token在池中的价格互为倒数，也就是以token0计价token1时 $\frac{x}{y}=\frac{1}{y/x}$，自然$\frac{1}{\sqrt{P}}=\frac{1}{\sqrt{y/x}}=\sqrt{\frac{x}{y}}$

$$
L=\frac{​Δy}{Δ\sqrt{P}}​
$$

### Pricing
同样，我们不需要计算实际价格，可以直接计算输出量。由于我们不打算跟踪和存储$x$和$y$，我们的计算将只基于$L$和$\sqrt{P}$

$$
Δy=Δ\sqrt{P}​L
$$

如前所述，储备之间互为倒数所以

$$
Δx=Δ\frac{1}{\sqrt{P}}​​L
$$

### Ticks
正如我们在本章中学到的，在V3中，V2的无限价格区间被分割成更小的价格区间。每个较小的价格范围都受到边界的限制。为了跟踪这些边界的坐标，Uniswap V3使用了刻度（_ticks_）。
![[Pasted image 20250214183318.png]]在 V3 中，整个价格范围由均匀分布的离散刻度线划分。每个刻度都有一个索引，并与某个价格相对应：

$$
p(i)=1.0001^i
$$

取1.0001的幂有一个理想的特性：相邻两个刻度点之间的差值为0.01%即1个基点（_basis point_）。
如上所述，Uniswap V3存的是$\sqrt{P}$，而不是$P$，因此这个式子实际上是

$$
\sqrt{p(i)}​=\sqrt{1.0001}^{i}=1.0001^\frac{i}{2}​
$$

tick可以是正/负数当然它不能是无穷。V3以定点数Q64.96类型存储$\sqrt{P}$，它以用64bit存储整数部分，96bit存储小数部分，所以价格在$[2^{-128}, 2^{128}]$之间而tick在

$$
[log_{1.0001}​2^{−128},log_{1.0001​}2^{128}]=[−887272,887272]
$$

区间。